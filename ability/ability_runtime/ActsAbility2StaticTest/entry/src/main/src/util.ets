import { Core } from './core';
import { ConfigService } from './module/config/configService';
import { AnyType } from './module/types/common';
import hilog from '@ohos.hilog'

export function getFuncWithArgsZero(func: (() => void) | (() => Promise<void>), timeout: int, isStressTest: boolean) {
  return new Promise<void>(async (resolve: (value: PromiseLike<void>) => void, reject: (value: object) => void) => {
    let timer:number;
    if (!isStressTest) {
      timer = setTimeout(() => {
        reject(new Error('execute timeout ' + timeout + 'ms'));
      }, timeout);
    }
    try {
      hilog.info(0x0000, 'testTag', '%{public}s', `xushijie-xushijie-util004`);
      hilog.info(0x0000, 'testTag', '%{public}s', `xushijie-xushijie-util004func-${typeof func}`);

      await (func as () => Promise<void>)();
      hilog.info(0x0000, 'testTag', '%{public}s', `xushijie-xushijie-util005`);

    } catch (err: Error) {
      hilog.info(0x0000, 'testTag', '%{public}s', `xushijie-xushijie-util006-${err.message}`);  // undefined cannot be cast to Promise<void>

    }
    if (!!timer) {
      clearTimeout(timer);
    }
    resolve(Promise.resolve());
  });
}

export function getAsyncFuncWithArgsOne(
  func: (params: () => void) => Promise<void>,
  timeout: int,
  isStressTest: boolean
) {
  return new Promise<void>(async (resolve: (value: PromiseLike<void>) => void, reject: (reason: Error) => void) => {
    let timer:number;
    if (!isStressTest) {
      timer = setTimeout(() => {
        reject(new Error('execute timeout ' + timeout + 'ms'));
      }, timeout);
    }

    const done = () => {
      if (!!timer) {
        clearTimeout(timer);
      }
      resolve(Promise.resolve());
    };

    try {
      await func(done);
    } catch (err: Error) {
      if (!!timer) {
        clearTimeout(timer);
      }
      reject(err);
    }
  });
}

export function getFuncWithArgsOne(func: (params: () => void) => void, timeout: int, isStressTest: boolean) {
  return new Promise<void>(async (resolve: (value: PromiseLike<void>) => void, reject: (reason: Error) => void) => {
    let timer:number;
    if (!isStressTest) {
      timer = setTimeout(() => {
        reject(new Error('execute timeout ' + timeout + 'ms'));
      }, timeout);
    }

    const done = () => {
      if (!!timer) {
        clearTimeout(timer);
      }
      resolve(Promise.resolve());
    };

    try {
      func(done);
    } catch (err: Error) {
      if (!!timer) {
        clearTimeout(timer);
      }
      reject(err);
    }
  });
}

export function getAsyncFuncWithArgsTwo(
  func: (param1: () => void, param2: AnyType) => Promise<void>,
  timeout: int,
  paramItem: AnyType,
  isStressTest: boolean
) {
  return new Promise<void>(async (resolve: (value: PromiseLike<void>) => void, reject: (reason: Error) => void) => {
    let timer:number;
    if (!isStressTest) {
      timer = setTimeout(() => {
        reject(new Error('execute timeout ' + timeout + 'ms'));
      }, timeout);
    }

    const done = () => {
      if (!!timer) {
        clearTimeout(timer);
      }
      resolve(Promise.resolve());
    };

    try {
      await func(done, paramItem);
    } catch (err: Error) {
      if (!!timer) {
        clearTimeout(timer);
      }
      reject(err);
    }
  });
}

export function getFuncWithArgsTwo(
  func: (param1: () => void, param2: AnyType) => void,
  timeout: int,
  paramItem: AnyType,
  isStressTest: boolean
) {
  return new Promise<void>(async (resolve: (value: PromiseLike<void>) => void, reject: (reason: Error) => void) => {
    let timer:number;
    if (!isStressTest) {
      timer = setTimeout(() => {
        reject(new Error('execute timeout ' + timeout + 'ms'));
      }, timeout);
    }

    const done = () => {
      if (!!timer) {
        clearTimeout(timer);
      }
      resolve(Promise.resolve());
    };

    try {
      func(done, paramItem);
    } catch (err: Error) {
      if (!!timer) {
        clearTimeout(timer);
      }
      reject(err);
    }
  });
}

export function processFunc(
  coreContext: Core,
  func: ((param1?: () => void) => void) | ((param1?: () => void) => Promise<void>)
) {
  hilog.info(0x0000, 'testTag', '%{public}s', `xushijie-xushijie-util001`);

  const configService = coreContext.getDefaultService('config');
  if (configService !== null) {
    const config = configService as ConfigService;
    config.setSupportAsync(true);
    const timeout = config.timeout === undefined ? 5000 : Number(config.timeout);
    let isStressTest = false;
    if (coreContext.getServices('dataDriver')) {
      if (config.getStress() > 1) {
        isStressTest = true;
      } else {
        isStressTest = false;
      }
    } else {
      isStressTest = false;
    }
    hilog.info(0x0000, 'testTag', '%{public}s', `xushijie-xushijie-util002`);

    return () => {
      hilog.info(0x0000, 'testTag', '%{public}s', `xushijie-xushijie-util003`);
      hilog.info(0x0000, 'testTag', '%{public}s', `xushijie-xushijie-util003func-${typeof func}`);


      return getFuncWithArgsZero(func, timeout as int, isStressTest);
    };
  }
  return () => {
    return getFuncWithArgsZero(func, 0, false);
  };
}

export function processAsyncFuncWithArgOne(coreContext: Core, func: (done: () => void) => Promise<void>) {
  const configService = coreContext.getDefaultService('config');
  if (configService !== null) {
    const config = configService as ConfigService;
    config.setSupportAsync(true);
    const timeout = config.timeout === undefined ? 5000 : Number(config.timeout);
    const isStressTest = coreContext.getServices('dataDriver') !== undefined || config.getStress() > 1;
    return () => {
      return getAsyncFuncWithArgsOne(func, timeout as int, isStressTest);
    };
  }
  return () => {
    return getAsyncFuncWithArgsOne(func, 0, false);
  };
}

export function processFuncWithArgOne(coreContext: Core, func: (done: () => void) => void) {
  const configService = coreContext.getDefaultService('config');
  if (configService !== null) {
    const config = configService as ConfigService;
    config.setSupportAsync(true);
    const timeout = config.timeout === undefined ? 5000 : Number(config.timeout);
    const isStressTest = coreContext.getServices('dataDriver') !== undefined || config.getStress() > 1;
    return () => {
      return getFuncWithArgsOne(func, timeout as int, isStressTest);
    };
  }
  return () => {
    return getFuncWithArgsOne(func, 0, false);
  };
}

export function processAsyncFuncWithArgTwo(
  coreContext: Core,
  func: (param1: () => void, param2: AnyType) => Promise<void>
) {
  const configService = coreContext.getDefaultService('config');
  if (configService !== null) {
    const config = configService as ConfigService;
    config.setSupportAsync(true);
    const timeout = config.timeout === undefined ? 5000 : Number(config.timeout);
    const isStressTest = coreContext.getServices('dataDriver') !== undefined || config.getStress() > 1;
    return (paramItem: AnyType) => {
      return getAsyncFuncWithArgsTwo(func, timeout as int, paramItem, isStressTest);
    };
  }
  return (paramItem: AnyType) => {
    return getAsyncFuncWithArgsTwo(func, 0, paramItem, false);
  };
}

export function processFuncWithArgTwo(coreContext: Core, func: (param1: () => void, param2: AnyType) => void) {
  const configService = coreContext.getDefaultService('config');
  if (configService !== null) {
    const config = configService as ConfigService;
    config.setSupportAsync(true);
    const timeout = config.timeout === undefined ? 5000 : Number(config.timeout);
    const isStressTest = coreContext.getServices('dataDriver') !== undefined || config.getStress() > 1;
    return (paramItem: AnyType) => {
      return getFuncWithArgsTwo(func, timeout as int, paramItem, isStressTest);
    };
  }
  return (paramItem: AnyType) => {
    return getFuncWithArgsTwo(func, 0, paramItem, false);
  };
}
