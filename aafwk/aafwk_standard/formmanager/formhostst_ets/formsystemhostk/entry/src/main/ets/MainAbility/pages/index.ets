import featureAbility from '@ohos.ability.featureAbility';
import formHost from '@ohos.application.formHost';
import commonEvent from '@ohos.commonEvent';
import { getCurrentTime } from '@ohos.systemTime';

// @ts-nocheck
@Entry
@Component
struct Index {
  @State formId: number = 0;
  @State bundle: string = `com.form.formsystemtestservicea.hmservice`;
  @State ability: string = `com.form.formsystemtestservicea.hmservice.MainAbility`;
  @State moduleName: string = `entry`;
  @State name: string = `Form_Js001`;
  @State canCreateForm: boolean = false;
  @State allowUpdate: boolean = true;
  @State isShowing: boolean = true;
  @State dimension: FormDimension = FormDimension.Dimension_1_2;
  @State temporary: boolean = false;
  private requestForm = false;
  private requestId = `-1`;
  private temporaryId = `-1`;
  private deleteForm = false;
  private deleteId = `-1`;
  private castTempForm = false;
  private notifyVisibility = false;
  private notifyVisibleForms = false;
  private notifyInvisibleForms = false;
  private releaseForm = false;
  private releaseId = "-1";
  private update = false;
  private enableUpdate = false;
  private disableUpdate = false;
  private isVisible = false;
  private castForm = false;
  private tempFormId = 0;
  private createTempAndNormal = false;
  private tempParam = {};
  private createSecondForm = false;
  private secondParam = {};
  private subscriberDel;
  private subscriberFormDeleteEvent = {
    events: ["FMS_FormDelete_commonEvent"]
  };
  private TAG = `[FormComponent.hostk]`;

  private formOnAcquiredEvent = "FMS_FormOnAcquired_commonEvent";
  private formOnRequestEvent = "FMS_FormOnRequest_commonEvent";
  private formOnDeletedEvent = "FMS_FormOnDeleted_commonEvent";
  private formOnReleasedEvent = "FMS_FormOnReleased_commonEvent";

  private onAcquiredCallback() {
    console.info(`${this.TAG} onAcquiredCallback`);
  }

  private onRequestCallback() {
    console.info(`====>${this.TAG} onRequestCallback====>`);
  }

  private onDeletedCallback() {
    console.info(`${this.TAG} onDeletedCallback`);
  }

  private onReleasedCallback() {
    console.info(`====>${this.TAG} onReleasedCallback====>`);
  }

  private unsubscribeDeleteCallback() {
    console.info(`${this.TAG} unSubscribeDeleteCallback`);
  }

  async private aboutToAppear() {
    const onDeleteEventSubscriber = await commonEvent.createSubscriber(this.subscriberFormDeleteEvent);
    commonEvent.subscribe(onDeleteEventSubscriber, async (err, data) => {
      const formIds = data.parameters.formIds;
      console.info(`${this.TAG} deleteCallback data: ${JSON.stringify(data)}, error: ${JSON.stringify(err)}`);
      console.info(`${this.TAG} deleteCallback formIds: ${JSON.stringify(formIds)}`);

      let deletedFormAmount = 0;
      formIds.forEach(async (formId, index) => {
        try {
          const res = await formHost.deleteForm(formId);
          ++deletedFormAmount;
          console.info(`${this.TAG} deleteForm${index} result: ${JSON.stringify(res)}`);
        } catch (error) {
          console.info(`${this.TAG} deleteForm${index} error: ${JSON.stringify(error)}`);
        }

        if (index >= formIds.length - 1) {
          commonEvent.unsubscribe(onDeleteEventSubscriber, () => this.unsubscribeDeleteCallback());

          const commonEventPublishData = {
            parameters: {
              deletedFormAmount: deletedFormAmount,
              formIds: [].concat(data.parameters.formIds)
            }
          };
          commonEvent.publish(this.formOnDeletedEvent, commonEventPublishData, () => this.onDeletedCallback());
          console.info(`${this.TAG} deleteCallback end, deletedFormAmount ${deletedFormAmount}`);
        }
      });
    });

    featureAbility.getWant()
      .then(async (want: any) => {
        console.info(`${this.TAG} getWant: ${JSON.stringify(want)}`);
        this.formId = want.parameters.formId;
        this.name = want.parameters.name;
        this.bundle = want.parameters.bundle;
        this.ability = want.parameters.ability;
        if (want.parameters.moduleName) {
          this.moduleName = want.parameters.moduleName;
        }
        if (want.parameters.temporary) {
          this.temporary = want.parameters.temporary;
        }
        if (want.parameters.dimension) {
          this.dimension = want.parameters.dimension;
        }
        if (want.parameters.castForm) {
          this.castForm = want.parameters.castForm;
        }
        if (want.parameters.temporaryId) {
          this.temporaryId = want.parameters.temporaryId;
        }
        if (want.parameters.requestForm) {
          this.requestForm = want.parameters.requestForm;
        }
        if (want.parameters.requestId) {
          this.requestId = want.parameters.requestId;
        }
        if (want.parameters.createSecondForm) {
          this.createSecondForm = want.parameters.createSecondForm;
          this.secondParam = want.parameters.secondParam;
        }
        if (want.parameters.createTempAndNormal) {
          this.createTempAndNormal = want.parameters.createTempAndNormal;
          this.tempParam = want.parameters.tempParam;
        }
        if (want.parameters.deleteForm) {
          this.deleteForm = want.parameters.deleteForm;
        }
        if (want.parameters.deleteId) {
          this.deleteId = want.parameters.deleteId;
        }
        if (want.parameters.castTempForm) {
          this.castTempForm = want.parameters.castTempForm;
        }
        if (want.parameters.notifyVisibility) {
          this.notifyVisibility = want.parameters.notifyVisibility;
        }
        if (want.parameters.notifyVisibleForms) {
          this.notifyVisibleForms = want.parameters.notifyVisibleForms;
        }
        if (want.parameters.notifyInvisibleForms) {
          this.notifyInvisibleForms = want.parameters.notifyInvisibleForms;
        }
        if (want.parameters.releaseForm) {
          this.releaseForm = want.parameters.releaseForm;
        }
        if (want.parameters.releaseId) {
          this.releaseId = want.parameters.releaseId;
        }
        if (want.parameters.update) {
          this.update = want.parameters.update;
        }
        if (want.parameters.enableUpdate) {
          this.enableUpdate = want.parameters.enableUpdate;
        }
        if (want.parameters.disableUpdate) {
          this.disableUpdate = want.parameters.disableUpdate;
        }
        if (want.parameters.subscribeTerminate) {
          let onTerminateEventSubscriber;
          const onTerminateCallback = async (err, data) => {
            console.info(`${this.TAG} onTerminateCallback data: ${JSON.stringify(data)}, error: ${JSON.stringify(err)}`);
            commonEvent.unsubscribe(onTerminateEventSubscriber, () => { });
            console.info(`${this.TAG} onTerminateCallback end`);
            setTimeout(async () => {
              // terminate self
              featureAbility.terminateSelf();
              console.info(`${this.TAG} featureAbility.terminateSelf`);
            }, 1000);
          }
          onTerminateEventSubscriber = await commonEvent.createSubscriber({
            events: [`FMS_FormTerminate_commonEvent`],
          });
          commonEvent.subscribe(onTerminateEventSubscriber, () => onTerminateCallback);
        }
        if (want.parameters.isCreate) {
          this.canCreateForm = want.parameters.isCreate;
        }

        if (!want.parameters.isCreate && this.deleteForm) {
          console.log(`${this.TAG} deleteForm start`);
          formHost.deleteForm(this.deleteId)
            .then((data) => {
              console.info(`${this.TAG} deleteForm result: ${JSON.stringify(data)}`);
              let commonEventPublishData = {
                data: data || `0`,
                parameters: {
                  "formId": this.deleteId
                }
              };
              commonEvent.publish(this.formOnDeletedEvent, commonEventPublishData, this.onDeletedCallback);
            })
            .catch((error) => {
              console.info(`${this.TAG} deleteForm error: ${JSON.stringify(error)}`);
              let commonEventPublishData = {
                data: error.code.toString(),
                parameters: {
                  "formId": this.deleteId
                }
              };
              commonEvent.publish(this.formOnDeletedEvent, commonEventPublishData, this.onDeletedCallback);
            });
        }

        if (!want.parameters.isCreate && this.releaseForm) {
          console.log(`${this.TAG} releaseForm start`);
          formHost.releaseForm(this.releaseId, true)
            .then((data) => {
              console.info(`${this.TAG} releaseForm result: ${JSON.stringify(data)}`);
              let commonEventPublishData = {
                data: data || `0`,
                parameters: {
                  "formId": this.releaseId
                }
              };
              commonEvent.publish(this.formOnReleasedEvent, commonEventPublishData, this.onReleasedCallback);
            })
            .catch((error) => {
              console.info(`${this.TAG} releaseForm error: ${JSON.stringify(error)}`);
              let commonEventPublishData = {
                data: error.code.toString(),
                parameters: {
                  "formId": this.releaseId
                }
              };
              commonEvent.publish(this.formOnReleasedEvent, commonEventPublishData, this.onReleasedCallback);
            });
        }

        if (!this.canCreateForm && this.requestForm) {
          let commonEventPublishData;
          formHost.requestForm(this.requestId)
            .then((data) => {
              console.info(`${this.TAG} requestForm result: ${JSON.stringify(data)}`);
              commonEventPublishData = {
                data: data || `0`,
                parameters: {
                  "formId": this.requestId
                }
              };
              commonEvent.publish(this.formOnRequestEvent, commonEventPublishData, this.onRequestCallback);
            })
            .catch((error) => {
              console.info(`${this.TAG} requestForm error: ${JSON.stringify(error)}`);
              commonEventPublishData = {
                parameters: {
                  "error": error
                }
              };
              commonEvent.publish(this.formOnRequestEvent, commonEventPublishData, this.onRequestCallback);
            });
        }
      })
      .catch((error: any) => {
        console.error(`${this.TAG} Operation failed. Cause: ${JSON.stringify(error)}`);
      })
  }

  build() {
    Column() {
      Text(`form component test begin`)
      Column() {
        if (this.canCreateForm) {
          FormComponent({
            id: this.formId,
            name: this.name,
            bundle: this.bundle,
            ability: this.ability,
            module: this.moduleName,
            dimension: this.dimension,
            temporary: this.temporary,
          })
            .allowUpdate(this.allowUpdate)
            .visibility(this.isShowing ? Visibility.Visible : Visibility.Hidden)
            .onAcquired(async (form) => {
              const createdTime = await getCurrentTime();
              this.formId = form.id;
              console.info(`${this.TAG} get form, form id: ${form.id}`);
              if (this.deleteForm) {
                try {
                  const startTime = await getCurrentTime();
                  const res = await formHost.deleteForm(this.formId);
                  const endTime = await getCurrentTime();
                  console.info(`${this.TAG} deleteForm result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `deleteForm`,
                      formId: this.formId,
                      startTime: startTime,
                      hostTime: endTime - startTime
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.formOnAcquiredEvent());
                } catch (error) {
                  console.info(`${this.TAG} deleteForm error: ${JSON.stringify(error)}`);
                }
              } else if (this.castTempForm) {
                try {
                  const startTime = await getCurrentTime();
                  const res = await formHost.castTempForm(this.formId);
                  const endTime = await getCurrentTime();
                  console.info(`${this.TAG} castTempForm result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `castTempForm`,
                      formId: this.formId,
                      startTime: startTime,
                      hostTime: endTime - startTime
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.formOnAcquiredEvent());
                } catch (error) {
                  console.info(`${this.TAG} castTempForm error: ${JSON.stringify(error)}`);
                }
              } else if (this.notifyVisibility) {
                try {
                  const res = await formHost.notifyVisibleForms([this.formId]);
                  console.info(`${this.TAG} notifyVisibleForms result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `notifyVisibleForms`,
                      formId: this.formId,
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.formOnAcquiredEvent());
                } catch (error) {
                  console.info(`${this.TAG} notifyVisibleForms error: ${JSON.stringify(error)}`);
                }
                try {
                  const res = await formHost.notifyInvisibleForms([this.formId]);
                  console.info(`${this.TAG} notifyInvisibleForms result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `notifyInvisibleForms`,
                      formId: this.formId,
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.formOnAcquiredEvent());
                } catch (error) {
                  console.info(`${this.TAG} notifyInvisibleForms error: ${JSON.stringify(error)}`);
                }
              } else if (this.notifyVisibleForms) {
                try {
                  const startTime = await getCurrentTime();
                  const res = await formHost.notifyVisibleForms([this.formId]);
                  const endTime = await getCurrentTime();
                  console.info(`${this.TAG} notifyVisibleForms result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `notifyVisibleForms`,
                      formId: this.formId,
                      startTime: startTime,
                      hostTime: endTime - startTime
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.formOnAcquiredEvent());
                } catch (error) {
                  console.info(`${this.TAG} notifyVisibleForms error: ${JSON.stringify(error)}`);
                }
              } else if (this.notifyInvisibleForms) {
                try {
                  const startTime = await getCurrentTime();
                  const res = await formHost.notifyInvisibleForms([this.formId]);
                  const endTime = await getCurrentTime();
                  console.info(`${this.TAG} notifyInvisibleForms result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `notifyInvisibleForms`,
                      formId: this.formId,
                      startTime: startTime,
                      hostTime: endTime - startTime
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.formOnAcquiredEvent());
                } catch (error) {
                  console.info(`${this.TAG} notifyInvisibleForms error: ${JSON.stringify(error)}`);
                }
              } else if (this.requestForm) {
                try {
                  const startTime = await getCurrentTime();
                  const res = await formHost.requestForm(this.formId);
                  const endTime = await getCurrentTime();
                  console.info(`${this.TAG} requestForm result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `request`,
                      formId: this.formId,
                      startTime: startTime,
                      hostTime: endTime - startTime
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
                } catch (error) {
                  console.info(`${this.TAG} requestForm error: ${JSON.stringify(error)}`);
                }
              } else if (this.releaseForm) {
                try {
                  const startTime = await getCurrentTime();
                  const res = await formHost.releaseForm(this.formId);
                  const endTime = await getCurrentTime();
                  console.info(`${this.TAG} releaseForm result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `release`,
                      formId: this.formId,
                      hostTime: endTime - startTime
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
                } catch (error) {
                  console.info(`${this.TAG} releaseForm error: ${JSON.stringify(error)}`);
                }
              } else if (this.update) {
                try {
                  const res = await formHost.enableFormsUpdate([this.formId]);
                  console.info(`${this.TAG} enableUpdate result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `enableUpdate`,
                      formId: this.formId,
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
                } catch (error) {
                  console.info(`${this.TAG} enableUpdate error: ${JSON.stringify(error)}`);
                }
                try {
                  const res = await formHost.disableFormsUpdate([this.formId]);
                  console.info(`${this.TAG} disableUpdate result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `disableUpdate`,
                      formId: this.formId,
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
                } catch (error) {
                  console.info(`${this.TAG} disableUpdate error: ${JSON.stringify(error)}`);
                }
              } else if (this.enableUpdate) {
                try {
                  const startTime = await getCurrentTime();
                  const res = await formHost.enableFormsUpdate([this.formId]);
                  const endTime = await getCurrentTime();
                  console.info(`${this.TAG} enableUpdate result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `enableUpdate`,
                      formId: this.formId,
                      hostTime: endTime - startTime
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
                } catch (error) {
                  console.info(`${this.TAG} enableUpdate error: ${JSON.stringify(error)}`);
                }
              } else if (this.disableUpdate) {
                try {
                  const startTime = await getCurrentTime();
                  const res = await formHost.disableFormsUpdate([this.formId]);
                  const endTime = await getCurrentTime();
                  console.info(`${this.TAG} disableUpdate result: ${JSON.stringify(res)}`);
                  const commonEventPublishData = {
                    data: res || `0`,
                    parameters: {
                      kind: `disableUpdate`,
                      formId: this.formId,
                      hostTime: endTime - startTime
                    }
                  };
                  commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
                } catch (error) {
                  console.info(`${this.TAG} disableUpdate error: ${JSON.stringify(error)}`);
                }
              } else {
                const commonEventPublishData = {
                  data: this.formId.toString(),
                  parameters: {
                    formId: this.formId.toString(),
                    time: createdTime
                  }
                };
                commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
              }
            })
            .onUninstall((info) => {
              console.info(`${this.TAG} onUninstall: ${JSON.stringify(info)}`);
              const commonEventPublishData = {
                parameters: {
                  formId: info.id.toString(),
                  kind: "onUninstall"
                }
              };
              commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
            })
            .onError((error) => {
              console.error(`${this.TAG} onError: ${JSON.stringify(error)}`);
            })
        }
        if (this.createSecondForm) {
          FormComponent({
            id: this.secondParam.formId,
            name: this.secondParam.name,
            bundle: this.secondParam.bundle,
            ability: this.secondParam.ability,
            module: this.secondParam.moduleName,
            dimension: FormDimension.Dimension_1_2,
            temporary: this.secondParam.temporary,
          })
            .allowUpdate(this.allowUpdate)
            .visibility(this.isShowing ? Visibility.Visible : Visibility.Hidden)
            .onAcquired((form) => {
              console.info(`${this.TAG} secondForm onAcquired, form id: ${form.id}`);
              this.formId = form.id;
              const commonEventPublishData = {
                data: this.formId.toString(),
                parameters: {
                  "formId": this.formId.toString()
                }
              };
              commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
            })
            .onUninstall((info) => {
              console.info(`${this.TAG} onUninstall: ${JSON.stringify(info)}`);
            })
            .onError((error) => {
              console.error(`${this.TAG} onError: ${JSON.stringify(error)}`);
            });
        }
        if (this.createTempAndNormal) {
          FormComponent({
            id: this.tempParam.formId,
            name: this.tempParam.name,
            bundle: this.tempParam.bundle,
            ability: this.tempParam.ability,
            module: this.tempParam.moduleName,
            dimension: FormDimension.Dimension_1_2,
            temporary: true,
          })
            .allowUpdate(this.allowUpdate)
            .visibility(this.isShowing ? Visibility.Visible : Visibility.Hidden)
            .onAcquired((form) => {
              console.info(`${this.TAG} castForm onAcquired, form id: ${form.id}`);
              this.formId = form.id;
              const commonEventPublishData = {
                data: this.formId.toString(),
                parameters: {
                  "formId": this.formId.toString(),
                  "cast": true,
                }
              };
              commonEvent.publish(this.formOnAcquiredEvent, commonEventPublishData, () => this.onAcquiredCallback());
            })
            .onUninstall((info) => {
              console.info(`${this.TAG} onUninstall: ${JSON.stringify(info)}`);
            })
            .onError((error) => {
              console.error(`${this.TAG} onError: ${JSON.stringify(error)}`);
            });
        }
      }
      .backgroundColor(Color.White)

      Text(`form component test end`);
    }
    .backgroundColor(Color.White)
  }
}
